<html>
  <head>
    <script src="https://api.mqcdn.com/sdk/mapquest-js/v1.1.0/mapquest.js"></script>
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.1.0/mapquest.css"/>


    <!-- Vizuly specific style sheets -->
    <link rel="stylesheet" href="lib/styles/vizuly.css">
    <link rel="stylesheet" href="lib/styles/vizuly_radial_progress.css">

    <script src="lib/d3.min.js"></script>
    <script src="lib/vizuly_core.min.js"></script>
    <script src="lib/vizuly_radialprogress.min.js"></script>

    <script src="lib/agora/vendor-bundle.js"></script>
    <script src="lib/agora/AgoraRTCSDK-1.12.0.js"></script>
    <script src="lib/agora/meeting.js"></script>

    <script type="text/javascript">
var sheltersX = [
    {
        "location": "Tampa, FL",
        "population": [50, 80, "green"],
        "water": [75, 100, "blue"]
    },
    {
        "location": "Miami, FL",
        "population": [48, 100, "green"],
        "water": [25, 100, "blue"]
    },
    {
        "location": "Orlando, FL",
        "population": [90, 100, "green"],
        "water": [25, 100, "blue"]
    },
];

var shelters = [
    {
        "name": "Copperfield Baptist Church",
        "street": "8350 Hwy 6N",
        "city": "Houston"
    }, {
        "name": "Golden Acres Baptist Church",
        "street": "2813 Pansy Street",
        "city": "Pasadena"
    }, {
        "name": "Memorial Drive Presbyterian Church",
        "street": "11612 Memorial Dr",
        "city": "Houston"
    }, {
        "name": "St. Thomas Moore Catholic Church",
        "street": "10330 Hillcroft St",
        "city": "Houston"
    }, {
        "name": "Cypress Ridge High School",
        "street": "7900 N. Eldridge",
        "city": "Houston"
    }, {
        "name": "Metropolitan Baptist Church",
        "street": "13000 Jones Rd",
        "city": "Houston"
    }, {
        "name": "Memorial Baptist Church",
        "street": "6900 Fairmont",
        "city": "Pasadena"
    }, {
        "name": "First Baptist Church - Lauder",
        "street": "4422 Lauder Rd",
        "city": "Houston"
    }
]

window.onload = function() {
    L.mapquest.key = 'tzjnBtklfROgvtSziM4XfidcYdriKBId';

    var locs = shelters.map(function(x) { return x.street + " " + x.city + " TX"; });
    var markerWidth = 64;

    L.mapquest.geocoding().geocode(locs, createMap);

    function createMap(error, response) {
        var map = L.mapquest.map('map', {
          center: [0, 0],
          layers: L.mapquest.tileLayer('light'),
          zoom: 14
        });
      
        var featureGroup = generateMarkersFeatureGroup(response);
      
        // Add markers to the map and zoom to the features
        featureGroup.addTo(map);
        map.fitBounds(featureGroup.getBounds());
      
        window.vizMarkers = [];
        for (var i = 0; i < shelters.length; i++) {
            var markerNode = document.getElementById("marker" + i);
            var vizMarker = vizuly.viz.radial_progress(markerNode);
            vizMarker.data(0)
                .min(0)
                .max(100)
                .capRadius(1)
                .startAngle(240)
                .endAngle(120)
                .arcThickness(.25);
            vizMarker.width(markerWidth).height(markerWidth).radius(markerWidth/2.2).update();
            vizMarker.selection().selectAll(".vz-radial_progress-arc").style("fill","green").style("stroke","white").style("stroke-width","1px").style("stroke-opacity","1");
            vizMarker.selection().selectAll(".vz-radial_progress-track").style("fill","grey").style("fill-opacity",0.5);
            vizMarker.selection().selectAll(".vz-radial_progress-label").style("display","none");
            window.vizMarkers.push(vizMarker);
        }

        updateMarkers('population');
    }

    function generateMarkersFeatureGroup(response) {
        var group = [];

        var videoElem = document.getElementById("agora-wrapper");
        videoElem.parentNode.removeChild(videoElem);
      
        for (var i = 0; i < response.results.length; i++) {
          var location = response.results[i].locations[0];
          var locationLatLng = location.latLng;
          let name = shelters[i].name;

          var pop = function(layer) {
              videoElem.childNodes[0].innerHTML = pop;
              window.initAgoraRTC();
              return videoElem;
          };
      
          var marker = L.marker(locationLatLng, {icon: L.divIcon({html: '<div id="marker' + i + '"></div>', iconSize: [markerWidth, markerWidth]})})
            .bindPopup(pop);
      
          group.push(marker);
        }
        return L.featureGroup(group);
    }
};

function updateMarkers(key) {
    for (var i = 0; i < shelters.length; i++) {
        var vizMarker = window.vizMarkers[i];
        var valMax = shelters[i][key];
        var val = valMax[0] / valMax[1] * 100;
        vizMarker.data(val).update();
        var color = valMax[2];
        vizMarker.selection().selectAll(".vz-radial_progress-arc").style("fill",color);
    }
}

    </script>
    <style type="text/css">
        .marker {
            background-color: gray;
        }

        .leaflet-div-icon {
            border: none;
            background: none;
        }
    </style>
  </head>

  <body style="border: 0; margin: 0;">
    <div id="map" style="width: 100%; height: 530px;"></div>

    <div>
        <a href="#" onclick="updateMarkers('population')">Population</a>
        <a href="#" onclick="updateMarkers('water')">Water</a>
    </div>


    <div id="div_device" class="panel panel-default" style="display:none">
        <div class="select">
            <label for="audioSource">Audio source: </label><select id="audioSource"></select>
        </div>
        <div class="select">
            <label for="videoSource">Video source: </label><select id="videoSource"></select>
        </div>
    </div>

    <div id="agora-wrapper" style="width:300px; height: 169px">
        <div class="room-name-title" id="room-name-meeting"></div>
        <div class="main-container">
            <div id="video-container-parent">
                <div id="video-container" class="video-container">
                    <div id="video-container-multiple"></div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
